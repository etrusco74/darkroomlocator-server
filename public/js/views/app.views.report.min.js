app.views.report=Backbone.View.extend({initialize:function(){console.log("initializing report view");$(window).on("resize",_.bind(this.resize_map,this))},events:{submit:"report","click #deleteReportButton":"report_delete","click #reportList a":"report_id","click #newReportButton":"report_new","click #shareFbButton":"report_share_fb","click #shareTwitterButton":"report_share_twitter","click #sharePermaButton":"report_share_perma","click #imgButton":"report_post_image","click #imgButtonClose":"report_close_image","click #imgButtonDel":"report_delete_images","change #reportTypes":"report_type_change"},render:function(e){$(this.el).html(this.template());this.report_renderReportsCollectionToUl();this.report_renderTypesCollectionToSelect(e);this.$("#reportForm").validate({rules:{geocomplete_report:"required",reportTypes:"required",description:"required",contact_email:{email:true},website:{url:true}},messages:this.language.form_messages});this.$("#my-dropzone").dropzone({url:app.const.apiurl()+"image",headers:{"X-Requested-With":"XMLHttpRequest",dir:""},maxFiles:5,maxFilesize:1,acceptedFiles:".jpeg,.jpg,.png,.gif,.JPEG,.JPG,.PNG,.GIF",clickable:true,addRemoveLinks:true,accept:function(e,t){console.log("uploaded");t()},init:function(){this.on("maxfilesexceeded",function(e){alert("No more files please!")});this.on("complete",function(e){console.log(e)});this.on("removedfile",function(e){app.views.report.prototype.report_delete_image(e);console.log(e)})}});return this},report:function(e){e.preventDefault();var t=this;bootbox.dialog({title:t.language.header_confirm_ins_message,message:t.language.body_confirm_ins_message,buttons:{confirm:{label:t.language.confirm_button,className:"btn btn-success",callback:function(){t.report_confirm();$("body").removeClass("modal-open")}},cancel:{label:t.language.cancel_button,className:"btn btn-info",callback:function(){$("body").removeClass("modal-open")}}}})},report_confirm:function(){var e=this;var t=this.report_formToJson();var n=new app.models.report;var r=app.const.apiurl()+"report";if(typeof t.id!=="undefined"){t.id!=""?r=r+"/id/"+t.id:r}n.save(t,{success:function(t){if(t.changed.success){bootbox.dialog({title:e.language.header_success_ins_message,message:e.language.body_success_ins_message,buttons:{main:{label:e.language.label_button,className:"btn btn-info",callback:function(){$("body").removeClass("modal-open");app.views.report.prototype.report_renderModelReportToForm(t.changed.report._id);app.views.report.prototype.report_renderReportsCollectionToUl()}}}})}else{bootbox.dialog({title:e.language.error_message,message:e.language.error_message+" : "+t.changed.error,buttons:{main:{label:e.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}})}console.log(t);console.log(t.changed)},error:function(t){bootbox.dialog({title:e.language.error_message,message:e.language.error_message,buttons:{main:{label:e.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}});console.log(t)},url:r,"private":true})},report_delete:function(e){var t=this;var n=this.report_formToJson();if(typeof n.id!=="undefined"){bootbox.dialog({title:t.language.header_confirm_del_message,message:t.language.body_confirm_del_message,buttons:{confirm:{label:t.language.confirm_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open");t.report_delete_confirm()}},cancel:{label:t.language.cancel_button,className:"btn btn-info",callback:function(){$("body").removeClass("modal-open")}}}})}else{bootbox.dialog({title:t.language.delete_header_error_message,message:t.language.delete_body_error_message,buttons:{main:{label:t.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}})}},report_delete_confirm:function(){var e=this;var t=this.report_formToJson();var n=new app.models.report(t);n.destroy({success:function(t){bootbox.dialog({title:e.language.header_success_del_message,message:e.language.body_success_del_message,buttons:{main:{label:e.language.label_button,className:"btn btn-info",callback:function(){$("body").removeClass("modal-open");app.views.report.prototype.report_renderModelReportToForm(0);app.views.report.prototype.report_renderReportsCollectionToUl()}}}});console.log(t);console.log(t.changed)},error:function(t){bootbox.dialog({title:e.language.error_message,message:e.language.error_message,buttons:{main:{label:e.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}});console.log(t)},url:app.const.apiurl()+"report/id/"+t.id,"private":true})},report_id:function(e){console.log(e);this.report_renderModelReportToForm(e.currentTarget.id)},report_new:function(e){console.log(e);this.report_renderModelReportToForm(0)},report_share_fb:function(e){console.log(e);var t=this;var n=this.report_formToJson();if(typeof n.id!=="undefined"){$.getScript(t.language.fb_connect_url,function(){FB.init({appId:t.language.fb_app_id,channelUrl:t.language.fb_channel_url});var e={method:"stream.publish",attachment:{name:t.language.fb_name,caption:t.language.fb_caption,description:t.language.fb_description+$("#reportTypes option:selected").text(),href:t.language.fb_href+n.id,media:[{type:"image",href:t.language.fb_href+n.id,src:t.language.fb_src}]},action_links:[{text:t.language.fb_action_links_text,href:t.language.fb_action_links_href}],user_prompt_message:t.language.user_prompt_message};FB.ui(e)})}else{bootbox.dialog({title:t.language.fb_header_error_message,message:t.language.fb_body_error_message,buttons:{main:{label:t.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}})}},report_share_twitter:function(e){console.log(e);var t=this;var n=this.report_formToJson();if(typeof n.id!=="undefined"){var r=575,i=400,s=($(window).width()-r)/2,o=($(window).height()-i)/2,u=t.language.bitly_login,a=t.language.bitly_apikey,f=t.language.twitter_url,l=t.language.twitter_long_url+n.id,c="?text="+t.language.twitter_text+$("#reportTypes option:selected").text(),h="&hashtags="+t.language.twitter_hash,p="status=1,width="+r+",height="+i+",top="+o+",left="+s;t.get_short_url(l,u,a,function(e){console.log(e);window.open(f+c+h+"&url="+e,"twitter",p)})}else{bootbox.dialog({title:t.language.twitter_header_error_message,message:t.language.twitter_body_error_message,buttons:{main:{label:t.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}})}},report_share_perma:function(e){console.log(e);var t=this;var n=this.report_formToJson();if(typeof n.id!=="undefined"){var r=t.language.bitly_login,i=t.language.bitly_apikey,s=t.language.twitter_long_url+n.id;t.get_short_url(s,r,i,function(e){console.log(e);t.$("#titlePerma").text(t.language.perma_header_message);t.$("#bodyPerma").text(t.language.perma_body_message);t.$("#linkPerma").text(e);t.$("#myModalPerma").modal("show")})}else{bootbox.dialog({title:t.language.perma_header_error_message,message:t.language.perma_body_error_message,buttons:{main:{label:t.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}})}},report_post_image:function(e){console.log(e);var t=this;var n=this.report_formToJson();if(typeof n.id!=="undefined"){var r=Dropzone.forElement("div#my-dropzone");r.options.headers.dir=n.id;t.$("#titleImages").text(t.language.image_header_message);t.$("#bodyImages").text(t.language.image_body_message);t.$("#myModalImages").modal("show")}else{bootbox.dialog({title:t.language.image_header_error_message,message:t.language.image_body_error_message,buttons:{main:{label:t.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}})}},report_delete_image:function(e){console.log(e);var t=this;var n=this.report_formToJson();var r=app.const.apiurl()+"image/dir/"+n.id+"/file/"+e.name;var i=new app.models.image(n);i.destroy({success:function(e){bootbox.dialog({title:t.language.image_header_success_del_message,message:t.language.image_body_success_del_message,buttons:{main:{label:t.language.label_button,className:"btn btn-info",callback:function(){$("body").removeClass("modal-open")}}}});console.log(e);console.log(e.changed)},error:function(e){bootbox.dialog({title:t.language.error_message,message:t.language.error_message,buttons:{main:{label:t.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}});console.log(e)},url:r,"private":true})},report_delete_images:function(e){var t=this;var n=this.report_formToJson();if(typeof n.id!=="undefined"){bootbox.dialog({title:t.language.image_header_confirm_del_all_message,message:t.language.image_body_confirm_del_all_message,buttons:{confirm:{label:t.language.confirm_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open");t.report_delete_images_confirm()}},cancel:{label:t.language.cancel_button,className:"btn btn-info",callback:function(){$("body").removeClass("modal-open")}}}})}else{bootbox.dialog({title:t.language.delete_header_error_message,message:t.language.delete_body_error_message,buttons:{main:{label:t.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}})}},report_delete_images_confirm:function(e){console.log(e);var t=this;var n=this.report_formToJson();var r=app.const.apiurl()+"images/dir/"+n.id;var i=new app.models.image(n);i.destroy({success:function(e){bootbox.dialog({title:t.language.image_header_success_del_all_message,message:t.language.image_body_success_del_all_message,buttons:{main:{label:t.language.label_button,className:"btn btn-info",callback:function(){$("body").removeClass("modal-open");app.views.report.prototype.report_renderImagesCollectionToDiv(n.id)}}}});console.log(e);console.log(e.changed)},error:function(e){bootbox.dialog({title:t.language.error_message,message:t.language.error_message,buttons:{main:{label:t.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}});console.log(e)},url:r,"private":true})},report_close_image:function(e){console.log(e);var t=this;var n=this.report_formToJson();t.report_renderImagesCollectionToDiv(n.id)},report_renderImagesCollectionToDiv:function(e){var t=this;var n=new app.collections.images;n.fetch({success:function(){console.log(n.models);var e=new Array;$("#imagesUploaded").empty();var t=n.models[0].get("data").resources;t.forEach(function(e){console.log(e);$("#imagesUploaded").append('<div class="imageUploaded"><img src="'+e.url+'"></div>')})},error:function(e,n){bootbox.dialog({title:t.language.error_message,message:t.language.error_message,buttons:{main:{label:t.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}})},url:app.const.apiurl()+"images/dir/"+e})},report_type_change:function(e){console.log(e);this.report_renderModelReportType($("#reportTypes").val())},report_renderModelReportType:function(e){var t=this;app.global.type_value="1";var n=new app.models.type;n.fetch({success:function(e){app.global.type_value=e.get("value");var t=$("#geocomplete_report").val();$("#geocomplete_report").geocomplete("find",t);console.log(e)},error:function(e){bootbox.dialog({title:t.language.error_message,message:t.language.error_message,buttons:{main:{label:t.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}});console.log(e)},url:app.const.apiurl()+"type/id/"+e,"private":false})},report_formToJson:function(){var e={};var t=$("#lng").text()*1;var n=$("#lat").text()*1;if($("#_id").val()!="")e.id=$("#_id").val();e.username_id=app.global.tokensCollection.at(0).get("_id");e.username=app.global.tokensCollection.at(0).get("username");e.type_id=$("#reportTypes").val();e.formatted_address=$("#formatted_address").text();e.country=$("#country").text();e.country_short=$("#country_short").text();e.region=$("#administrative_area_level_1").text();e.province=$("#administrative_area_level_2").text();e.postal_code=$("#postal_code").text();e.lng=t;e.lat=n;e.loc={};e.loc.type="Point";e.loc.coordinates=[];e.loc.coordinates.push(t,n);e.description=$("#description").val();e.note=$("#note").val();e.contact_email=$("#contact_email").val();e.website=$("#website").val();return e},report_renderModelReportToForm:function(e){var t=this;var n=new app.models.report;if(e!=0){n.fetch({success:function(t){$("#_id").val(t.get("_id"));$("#geocomplete_report").val(t.get("formatted_address"));$("#reportTypes").val(t.get("type_id")._id).attr("selected",true);app.global.type_value=t.get("type_id").value;$("#description").val(t.get("description"));$("#note").val(t.get("note"));var n=[];n=t.get("keywords");var r="",i;for(i=0;i<n.length;i++){r+='<span class="label label-info">'+n[i]+"</span> "}$("#tag").html(r);$("#contact_email").val(t.get("contact_email"));$("#website").val(t.get("website"));$("#formatted_address").text(t.get("formatted_address"));$("#country").text(t.get("country"));$("#country_short").text(t.get("country_short"));$("#administrative_area_level_1").text(t.get("region"));$("#administrative_area_level_2").text(t.get("province"));$("#postal_code").text(t.get("postal_code"));$("#lat").text(t.get("lat"));$("#lng").text(t.get("lng"));$("#geocomplete_report").geocomplete("find",t.get("formatted_address"));$("#accordion2").show();app.views.report.prototype.report_renderImagesCollectionToDiv(e);console.log(t)},error:function(e){bootbox.dialog({title:t.language.error_message,message:t.language.error_message,buttons:{main:{label:t.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}});console.log(e)},url:app.const.apiurl()+"report/id/"+e,"private":false})}else{$("#_id").val("");$("#geocomplete_report").val("");$("#reportTypes").val(0).attr("selected",true);app.global.type_value="1";$("#description").val("");$("#note").val("");$("#tag").html(t.language.tag_desc);$("#contact_email").val("");$("#website").val("");$("#formatted_address").text("");$("#country").text("");$("#country_short").text("");$("#administrative_area_level_1").text("");$("#administrative_area_level_2").text("");$("#postal_code").text("");$("#lat").text("");$("#lng").text("");$("#accordion2").hide()}},report_renderReportsCollectionToUl:function(){var e=this;var t=new app.collections.reports;t.fetch({success:function(){if(typeof t.models[0].get("_id")!=="undefined"){console.log(t.models);$("#reportList li").remove();for(var n=0 in t.models){$("#reportList").append('<li><i class="icon-chevron-right"></i><a href="#'+e.language.lang+"/report/type_id/"+t.models[n].get("type_id")._id+'" id="'+t.models[n].get("_id")+'">'+t.models[n].get("formatted_address")+"</a></li>")}}else{$("#reportList li").remove();$("#reportList").append("<li>"+e.language.no_report_desc+"</li>")}},error:function(t,n){bootbox.dialog({title:e.language.error_message_type,message:e.language.error_message_type,buttons:{main:{label:e.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}})},url:app.const.apiurl()+"reports/username/"+app.global.tokensCollection.at(0).get("username")})},report_renderTypesCollectionToSelect:function(e){var t=this;var n=new app.collections.types;n.fetch({success:function(){console.log(n.models);for(var r=0 in n.models){if(e==n.models[r].get("_id")){$("#reportTypes").append($("<option></option>").attr("value",n.models[r].get("_id")).text(n.models[r].get("description_"+t.language.lang)).attr("selected",true))}else{$("#reportTypes").append($("<option></option>").attr("value",n.models[r].get("_id")).text(n.models[r].get("description_"+t.language.lang)))}}},error:function(e,n){bootbox.dialog({title:t.language.error_message_type,message:t.language.error_message_type,buttons:{main:{label:t.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}})},url:app.const.apiurl()+"types"})},resize_map:function(){var e=$(window).height();var t=$("#navbar_content").height();var n=$("#footer_content").height();this.$el.find("#map_canvas_report").height(e-t-n-100)},init_map:function(){var e=this;e.resize_map();var t={map:e.$el.find("#map_canvas_report"),details:e.$el.find("#container"),detailsAttribute:"data-geo",markerOptions:{draggable:true,icon:"css/img/1.png"}};e.$("#accordion2").hide();e.$("#geocomplete_report").geocomplete(t);e.$("#geocomplete_report").bind("geocode:dragged",function(e,t){$("#geocomplete_report").geocomplete("find",t.lat()+","+t.lng())});this.$("#geocomplete_report").bind("geocode:result",function(e,t){console.log(t);$("#accordion2").show();var n=$("#geocomplete_report").geocomplete("map");var r=$("#geocomplete_report").geocomplete("marker");r.setIcon("css/img/"+app.global.type_value+".png")})},destroy_view:function(){$(window).off("resize");this.undelegateEvents();$(this.el).removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this);app.global.reportView=null},get_short_url:function(e,t,n,r){$.getJSON("http://api.bitly.com/v3/shorten?callback=?",{format:"json",apiKey:n,login:t,longUrl:e},function(e){r(e.data.url)})}})