app.views.mapdashboard=Backbone.View.extend({initialize:function(){console.log("initializing mapdashboard view");$(window).on("resize",_.bind(this.resize_map,this))},events:{"click #reportList":"moveToLocation"},render:function(){$(this.el).html(this.template());$(document).attr("title","darkroom locator - find and share darkrooms | "+this.language.type+" | "+this.language.lang);return this},resize_map:function(){var e=$(window).height();var t=$("#navbar_content").height();var n=$("#footer_content").height();this.$el.find("#map_canvas").height(e-t-n-50);this.$el.find("#map_sidebar_right_content").height(e-t-n-50)},init_map:function(e){var t=this;t.resize_map();var n={zoom:app.global.init_zoom,center:new google.maps.LatLng(t.language.init_lat,t.language.init_lng),mapTypeId:google.maps.MapTypeId.ROADMAP};app.global.map=new google.maps.Map(t.$("#map_canvas").get(0),n);if(typeof e!=="undefined")$.getJSON(app.const.apiurl()+"report/id/"+e,this.refreshMapUI);else $.getJSON(app.const.apiurl()+"reports",this.refreshMapUI)},renderReportsCollectionToMaps:function(e){var t=new google.maps.Geocoder;var n=e.lat+","+e.lng;t.geocode({address:n},function(t,n){if(n==google.maps.GeocoderStatus.OK){app.global.map.setCenter(t[0].geometry.location);switch(e.km){case"1":app.global.map.setZoom(12);break;case"10":app.global.map.setZoom(10);break;case"50":app.global.map.setZoom(8);break;case"100":app.global.map.setZoom(6);break;case"500":app.global.map.setZoom(5);break;case"1000":app.global.map.setZoom(4);break;case"0":app.global.map.setZoom(2);break;default:app.global.map.setZoom(10);break}}});$.getJSON(app.const.apiurl()+"reports/params/"+e.lat+"/"+e.lng+"/"+e.km+"/"+e.text+"/"+e.id,this.refreshMapUI)},refreshMapUI:function(e){var t=app.views.mapdashboard.prototype;app.views.mapdashboard.prototype.clearMarkers();var n;if(typeof e==="undefined"){n=0}else{if($.isArray(e)){n=e.length}else{if(typeof e._id==="undefined"){n=0}else{var r=e;var e=[r];n=e.length}}}$("#res_txt").text(n);var i="<div class='accordion' id='accordion1'>";for(var s=0;s<n;s++){moment.lang(t.language.lang);var o=moment(e[s].report_date).fromNow();var u=[];u=e[s].keywords;var a="",f;for(f=0;f<u.length;f++){a+='<span class="label label-info">'+u[f]+"</span> "}var l="";switch(t.language.lang){case"it":l=e[s].type_id.description_it;break;case"en":l=e[s].type_id.description_en;break;case"de":l=e[s].type_id.description_de;break;case"es":l=e[s].type_id.description_es;break;case"fr":l=e[s].type_id.description_fr;break;default:l=e[s].type_id.description_en;break}var c="<div id='infoBubble' class='col-lg-12'>"+t.language.html_user+" : <span class='label label-success'>"+e[s].username+"</span><br />"+t.language.html_type+" : <span class='label label-info'>"+l+"</span><br />"+"<img src='css/img/arrow-left_16.png'> <a href='#"+t.language.lang+"/mapdashboard/id/"+e[s]._id+"'>"+t.language.html_detail+"</a><br />"+t.language.html_location+" : <span class='text-muted'>"+e[s].region+" ("+e[s].province+")</span><br />"+t.language.html_description+" : <span class='text-danger'>"+e[s].description+"</span><br />"+t.language.html_note+" : <span class='text-success'>"+e[s].note+"</span><br />"+t.language.html_tag+" : "+a+"<br />"+t.language.html_date+" : <span class='text-danger'>"+o+"</span>";if(typeof e[s].website!=="undefined"&&e[s].website!=""){c+="<br />"+t.language.html_website_pre+" <a href='"+e[s].website+"' target='_blank'>"+t.language.html_website_in+"</a>"}if(typeof e[s].contact_email!=="undefined"&&e[s].contact_email!=""){c+="<br />"+t.language.html_email_pre+" <a href='mailto:"+e[s].contact_email+"'>"+t.language.html_email_in+"</a>"}c+=" </div>";var h=new google.maps.Marker({position:new google.maps.LatLng(e[s].lat,e[s].lng),map:app.global.map,icon:"css/img/"+e[s].type_id.value+".png",title:l,animation:google.maps.Animation.DROP});app.global.markers_array.push(h);google.maps.event.addListener(h,"click",app.views.mapdashboard.prototype.onMarkerClick(app.views.mapdashboard.prototype.infoBubble,h,c));var p=e[s].region;if(e[s].region=="")p=e[s].province;i+="<div class='accordion-group'>"+"      <div class='accordion-heading'>"+"          <a class='accordion-toggle' data-toggle='collapse' data-parent='#accordion1' href='#collapse"+s+"'>"+"         "+e[s].description+" ("+e[s].country_short+" - "+p+")"+"          </a>"+"      </div>"+"      <div id='collapse"+s+"' class='accordion-body collapse'>"+"          <div class='accordion-inner'>"+"<span class='label label-success'>"+e[s].username+"</span><br />"+"<span class='label label-info'>"+l+"</span><br />"+"<img src='css/img/arrow-left_16.png'> <a href='#' id='reportList' data-lat='"+e[s].lat+"' data-lon='"+e[s].lng+"'>"+t.language.html_find+"</a><br />"+"<img src='css/img/arrow-left_16.png'> <a href='#"+t.language.lang+"/mapdashboard/id/"+e[s]._id+"'>"+t.language.html_detail+"</a><br />"+"<span class='text-muted'>"+e[s].region+" ("+e[s].province+")</span><br />"+"<span class='text-success'>"+e[s].note+"</span><br />"+"<span class='text-danger'>"+o+"</span>";if(typeof e[s].website!=="undefined"&&e[s].website!=""){i+="<br />"+t.language.html_website_pre+" <a href='"+e[s].website+"' target='_blank'>"+t.language.html_website_in+"</a> <img src='css/img/arrow-right_16.png'> "}if(typeof e[s].contact_email!=="undefined"&&e[s].contact_email!=""){i+="<br />"+t.language.html_email_pre+" <a href='mailto:"+e[s].contact_email+"'>"+t.language.html_email_in+"</a> <img src='css/img/arrow-right_16.png'>"}i+="         </div>"+"     </div>"+"</div>"}i+="</div>";$("#map_sidebar_right_content").html(i)},moveToLocation:function(e){e.preventDefault();var t=$(e.target).data("lat");var n=$(e.target).data("lon");var r=new google.maps.LatLng(t,n);app.global.map.panTo(r);app.global.map.setZoom(12)},clearMarkers:function(){if(app.global.markers_array){for(var e=0;e<app.global.markers_array.length;e++){app.global.markers_array[e].setMap(null)}}},onMarkerClick:function(e,t,n){return function(){e.setContent(n);e.open(app.global.map,t)}},destroy_view:function(){$(window).off("resize");this.undelegateEvents();$(this.el).removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this);app.global.dashboardView=null},infoBubble:new InfoBubble({maxWidth:350,minHeight:200,backgroundColor:"#F2F2F2"})})