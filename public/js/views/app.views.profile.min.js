app.views.profile=Backbone.View.extend({initialize:function(){console.log("initializing profile view")},events:{submit:"profile_update","click #deleteProfileButton":"profile_delete"},render:function(){$(this.el).html(this.template());this.$("#gravatar").empty().append($.gravatar(app.global.tokensCollection.at(0).get("email"),{size:40}));this.$("#profileForm").validate({rules:{first_name:"required",last_name:"required",email:{required:true,email:true}},messages:this.language.form_messages});this.profile_modelToForm();return this},profile_update:function(e){e.preventDefault();var t=this;bootbox.dialog({title:t.language.header_confirm_upd_message,message:t.language.body_confirm_upd_message,buttons:{confirm:{label:t.language.confirm_button,className:"btn btn-success",callback:function(){$("body").removeClass("modal-open");t.profile_confirm_update()}},cancel:{label:t.language.cancel_button,className:"btn btn-info"}}})},profile_confirm_update:function(){var e=this;var t=this.profile_formToJson();var n=new app.models.user;n.save(t,{success:function(t){if(t.changed.success){app.global.tokensCollection.each(function(e){e.destroy()});var n=new app.models.token(t.get("user"));app.global.tokensCollection.add(n);n.save();bootbox.dialog({title:e.language.header_success_upd_message,message:e.language.body_success_upd_message,buttons:{main:{label:e.language.label_button,className:"btn btn-info",callback:function(){$("body").removeClass("modal-open")}}}})}else{bootbox.dialog({title:e.language.error_message,message:e.language.error_message+" : "+t.changed.error,buttons:{main:{label:e.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}})}console.log(t);console.log(t.changed)},error:function(t){bootbox.dialog({title:e.language.error_message,message:e.language.error_message,buttons:{main:{label:e.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}});console.log(t)},url:app.const.apiurl()+"user/id/"+t.id,"private":true})},profile_formToJson:function(){var e={};e.id=this.$("#_id").val();e.first_name=this.$("#first_name").val();e.last_name=this.$("#last_name").val();e.username=this.$("#username").val();e.email=this.$("#email").val();return e},profile_modelToForm:function(){var e=this;var t=new app.models.user;t.fetch({success:function(t){if(typeof t.get("_id")!=="undefined"){e.$("#_id").val(t.get("_id"));e.$("#first_name").val(t.get("first_name"));e.$("#last_name").val(t.get("last_name"));e.$("#username").val(t.get("username"));moment.lang(e.language.lang);var n=moment(t.get("registration_date")).fromNow();var r=moment(t.get("auth").login_date).fromNow();e.$("#registration_date").val(n);e.$("#login_date").val(r);e.$("#email").val(t.get("email"));console.log(t)}else{console.log(t);app.routers.router.prototype.logout()}},error:function(t){bootbox.dialog({title:e.language.error_message,message:e.language.error_message,buttons:{main:{label:e.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}});console.log(t)},url:app.const.apiurl()+"user/id/"+app.global.tokensCollection.first().get("_id"),"private":true})},profile_delete:function(){var e=this;bootbox.dialog({title:e.language.header_confirm_del_message,message:e.language.body_confirm_del_message,buttons:{confirm:{label:e.language.confirm_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open");e.profile_confirm_delete()}},cancel:{label:e.language.cancel_button,className:"btn btn-info"}}})},profile_confirm_delete:function(){var e=this;var t=this.profile_formToJson();var n=new app.models.user(t);n.destroy({success:function(t){bootbox.dialog({title:e.language.header_success_del_message,message:e.language.body_success_del_message,buttons:{main:{label:e.language.label_button,className:"btn btn-info",callback:function(){$("body").removeClass("modal-open");app.global.tokensCollection.each(function(e){e.destroy()});app.routers.router.prototype.index()}}}});console.log(t);console.log(t.changed)},error:function(t){bootbox.dialog({title:e.language.error_message,message:e.language.error_message,buttons:{main:{label:e.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}});console.log(t)},url:app.const.apiurl()+"user/id/"+t.id,"private":true})},destroy_view:function(){this.undelegateEvents();$(this.el).removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this);app.global.profileView=null}})