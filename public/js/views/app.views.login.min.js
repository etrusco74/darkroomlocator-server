app.views.login=Backbone.View.extend({initialize:function(){console.log("initializing login view");OAuth.initialize("87ohweKrXUAJvbcPOUjNkvoskvk")},events:{submit:"login","click #facebookButton":"facebook"},login_home:function(){app.routers.router.prototype.index()},render:function(){$(this.el).html(this.template());this.$("#loginForm").validate({rules:{username:{required:true,maxlength:20},password:{required:true,maxlength:12}},messages:this.language.form_messages});return this},login:function(e){e.preventDefault();var t=this;var n=this.login_formToJson();var r=new app.models.user;r.save(n,{success:function(e){if(e.changed.success){app.global.tokensCollection.each(function(e){e.destroy()});var n=new app.models.token(e.get("user"));app.global.tokensCollection.add(n);n.save();app.routers.router.prototype.dashboard()}else{bootbox.dialog({title:t.language.error_message,message:t.language.error_message+" : "+e.changed.error,buttons:{main:{label:t.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}})}console.log(e);console.log(e.changed)},error:function(e){bootbox.dialog({title:t.language.error_message,message:t.language.error_message,buttons:{main:{label:t.language.label_button,className:"btn btn-danger",callback:function(){$("body").removeClass("modal-open")}}}});console.log(e)},url:app.const.apiurl()+"login","private":false})},login_formToJson:function(){var e={};e.username=this.$("#username").val();e.password=this.$("#password").val();return e},facebook:function(e){OAuth.popup("facebook",function(e,t){if(e){console.log("error "+JSON.stringify(e));return}console.log("result "+JSON.stringify(t));var n="https://graph.facebook.com/me?access_token="+t.access_token;$.getJSON(n,function(e){console.log("user "+JSON.stringify(e));console.log("success");var t=new app.models.user(e);app.global.tokensCollection.add(t);t.save();app.routers.router.prototype.dashboard()})})},destroy_view:function(){this.undelegateEvents();$(this.el).removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this);app.global.loginView=null}})